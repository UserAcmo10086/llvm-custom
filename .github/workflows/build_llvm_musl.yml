name: Build LLVM (musl libc)
run-name: Build LLVM for r${{inputs.version}}${{inputs.revision}} ${{inputs.projects}}
on:
  workflow_dispatch:
    inputs:
      version:
        description: "NDK Release version:"
        default: "29"
        required: true
      revision:
        description: "NDK Release revision:"
        default: ''
        required: false
        type: string
      projects:
        description: "Projects to build:"
        default: "bolt;clang;clang-tools-extra;lld"
        required: true

permissions:
  contents: write
  actions: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        target: [aarch64-linux-musl]
    runs-on: ubuntu-24.04
    env:
      ROOTDIR: ${{github.workspace}}
      TARGET_BUILD_DIR: ${{github.workspace}}/build/${{matrix.target}}
      TARGET_INSTALL_DIR: ${{github.workspace}}/output/${{matrix.target}}
      ZIG_TARGET: ${{matrix.target}}
    steps:
      - name: Maximize build space
        uses: easimon/maximize-build-space@v10
        with:
          root-reserve-mb: 5120
          swap-size-mb: 5120
          remove-dotnet: true
          remove-android: true
          remove-haskell: true
          remove-codeql: true
          remove-docker-images: true

      - name: Checkout llvm-custom
        uses: actions/checkout@v5
        with:
          path: ${{github.workspace}}

      - name: Checkout llvm-project and apply android patches
        run: |
          set -e
          
          NDK_DIR="$ROOTDIR/android-ndk-r${{inputs.version}}${{inputs.revision}}"
          
          echo "Downloading NDK r${{inputs.version}}${{inputs.revision}}..."
          curl -sSfL -o android-ndk.zip "https://dl.google.com/android/repository/android-ndk-r${{inputs.version}}${{inputs.revision}}-linux.zip"
          unzip -qq android-ndk.zip -d $ROOTDIR
          
          # 提取版本信息
          LLVM_BIN="$NDK_DIR/toolchains/llvm/prebuilt/linux-x86_64/bin"
          CLANG_VERSION_CMD="$LLVM_BIN/clang --version"
          CLANG_SOURCE_INFO="$NDK_DIR/toolchains/llvm/prebuilt/linux-x86_64/clang_source_info.md"
          
          LLVM_VERSION=$($CLANG_VERSION_CMD | sed -n 's/.*clang version \([0-9][0-9.]*[a-zA-Z0-9]*\).*/\1/p')
          LLVM_REV=$($CLANG_VERSION_CMD | sed -E 's/.*llvm-project ([a-f0-9]{40}).*/\1/' | head -n 1)
          ANDROID_REV=$(grep 'llvm_android/+/.*' "$CLANG_SOURCE_INFO" | sed -n 's/.*llvm_android\/\+//; s/\/patches.*//p' | sed 's/\/\+//g; s/^\+//g' | head -n 1)
          
          if [[ -z "$LLVM_VERSION" || -z "$LLVM_REV" || -z "$ANDROID_REV" ]]; then
            echo "Error: Failed to extract necessary version/revision info."
            exit 1
          fi
          
          echo "LLVM Version: $LLVM_VERSION"
          echo "LLVM Revision: $LLVM_REV"
          echo "Android Revision: $ANDROID_REV"
          
          # 克隆完整的 llvm-project 仓库并检出指定版本
          echo "Cloning llvm-project repository..."
          git clone --quiet https://github.com/llvm/llvm-project.git $ROOTDIR/llvm-project-full
          cd $ROOTDIR/llvm-project-full
          
          echo "Checking out LLVM revision: $LLVM_REV"
          # 尝试多种方式检出
          if ! git checkout --quiet $LLVM_REV 2>/dev/null; then
            echo "Fetching revision $LLVM_REV..."
            git fetch --quiet origin $LLVM_REV 2>/dev/null || true
            if git rev-parse --verify $LLVM_REV >/dev/null 2>&1; then
              git checkout --quiet $LLVM_REV
            else
              # 如果特定的提交不存在，尝试使用标签
              echo "Revision $LLVM_REV not found, trying tags..."
              TAG=$(git tag --list "*$LLVM_VERSION*" | head -1)
              if [ -n "$TAG" ]; then
                echo "Checking out tag: $TAG"
                git checkout --quiet $TAG
              else
                echo "ERROR: Could not find LLVM revision $LLVM_REV or version $LLVM_VERSION"
                exit 1
              fi
            fi
          fi
          
          # 克隆 llvm_android 仓库
          echo "Cloning llvm_android at commit $ANDROID_REV..."
          git clone --quiet https://android.googlesource.com/toolchain/llvm_android $ROOTDIR/llvm_android
          cd $ROOTDIR/llvm_android
          git checkout --quiet $ANDROID_REV
          
          # 回到 llvm-project 目录应用补丁
          cd $ROOTDIR/llvm-project-full
          
          echo "Applying patches from llvm_android..."
          
          # 创建补丁失败记录文件
          PATCH_FAILURES="$ROOTDIR/patch_failures.log"
          > "$PATCH_FAILURES"
          
          # 定义已知有问题的补丁列表（从之前的错误中收集）
          PROBLEMATIC_PATCHES=(
            # 第一次出现的失败补丁
            "fc0aa8424ca98da29a9c7aa15b4427d47504ba87.patch"
            "b0343a38a5910e980bb031e4014655d77cd0c162.patch"
            
            # 第二次出现的失败补丁
            "Revert-two-changes-that-break-Android-builds.v6.patch"
            "Revert-two-changes-that-break-Android-builds.v7.patch"
            
            # 第三次出现的失败补丁
            "Revert-Sema-Introduce-BuiltinAttr-per-declaration-bu.v4.patch"
            
            # 可能还有其他变体
            "*Revert-*"
            "*fc0aa8424*"
            "*b0343a38a*"
          )
          
          # 函数：检查是否是问题补丁
          is_problematic_patch() {
            local patch_name="$1"
            for pattern in "${PROBLEMATIC_PATCHES[@]}"; do
              if [[ "$patch_name" == $pattern ]] || [[ "$patch_name" == *"$pattern"* ]]; then
                return 0  # 是问题补丁
              fi
            done
            return 1  # 不是问题补丁
          }
          
          # 函数：清理冲突标记
          clean_conflict_markers() {
            echo "Cleaning conflict markers in source files..."
            find . -type f \( -name "*.h" -o -name "*.cpp" -o -name "*.c" -o -name "*.cc" -o -name "*.hpp" -o -name "*.inc" -o -name "*.def" -o -name "*.td" \) \
              -exec grep -l "<<<<<<<" {} \; 2>/dev/null | while read file; do
              echo "  Cleaning: $file"
              # 删除冲突标记和相关内容
              sed -i -e '/^<<<<<<< /,/^=======$/d' -e '/^>>>>>>> /d' "$file"
            done
            
            # 特别检查已知有问题的文件
            if [ -f "llvm/include/llvm/ADT/Triple.h" ]; then
              echo "  Special cleaning: llvm/include/llvm/ADT/Triple.h"
              # 备份
              cp "llvm/include/llvm/ADT/Triple.h" "llvm/include/llvm/ADT/Triple.h.bak"
              # 删除冲突标记
              sed -i '/^<<<<<<< /d' "llvm/include/llvm/ADT/Triple.h"
              sed -i '/^=======$/d' "llvm/include/llvm/ADT/Triple.h"
              sed -i '/^>>>>>>> /d' "llvm/include/llvm/ADT/Triple.h"
            fi
          }
          
          # 函数：安全的补丁应用
          safe_apply_patch() {
            local patch_file="$1"
            local patch_name="$(basename "$patch_file")"
            
            # 检查是否是已知问题补丁
            if is_problematic_patch "$patch_name"; then
              echo "Skipping problematic patch: $patch_name"
              echo "  ⚠ Known problematic patch, skipping to avoid build errors"
              return 0
            fi
            
            echo "Applying $patch_name..."
            
            # 尝试 git apply
            if git apply --check "$patch_file" 2>/dev/null; then
              if git apply "$patch_file" 2>&1; then
                echo "  ✓ Applied successfully"
                return 0
              fi
            fi
            
            # 尝试 patch 命令
            echo "  ℹ git apply failed, trying patch command..."
            
            # 使用最简化的 patch 命令，避免复杂选项
            if patch -p1 -f < "$patch_file" 2>&1; then
              echo "  ✓ Applied successfully with patch"
              return 0
            else
              echo "  ⚠ Failed to apply patch: $patch_name" | tee -a "$PATCH_FAILURES"
              echo "  ⚠ Skipping this patch to continue build"
              return 1
            fi
          }
          
          # 应用 patches/ 目录下的补丁
          if [ -d "$ROOTDIR/llvm_android/patches" ]; then
            for PATCH in "$ROOTDIR/llvm_android/patches"/*.patch; do
              if [ -f "$PATCH" ]; then
                safe_apply_patch "$PATCH"
              fi
            done
          fi
          
          # 应用 cherry/ 目录下的补丁
          if [ -d "$ROOTDIR/llvm_android/patches/cherry" ]; then
            for PATCH in "$ROOTDIR/llvm_android/patches/cherry"/*.patch; do
              if [ -f "$PATCH" ]; then
                safe_apply_patch "$PATCH"
              fi
            done
          fi
          
          # 清理冲突标记
          clean_conflict_markers
          
          # 应用自定义补丁（musl）
          if [ -d "$ROOTDIR/patches/musl/llvm/$LLVM_VERSION" ]; then
            echo "Applying musl patches..."
            for PATCH in "$ROOTDIR/patches/musl/llvm/$LLVM_VERSION"/*.patch; do
              if [ -f "$PATCH" ]; then
                safe_apply_patch "$PATCH"
              fi
            done
          fi
          
          # 应用全局补丁
          if [ -d "$ROOTDIR/patches/global/llvm/$LLVM_VERSION" ]; then
            echo "Applying global patches..."
            for PATCH in "$ROOTDIR/patches/global/llvm/$LLVM_VERSION"/*.patch; do
              if [ -f "$PATCH" ]; then
                safe_apply_patch "$PATCH"
              fi
            done
          fi
          
          # 最终清理冲突标记
          clean_conflict_markers
          
          # 清理所有 .rej 文件
          find . -name "*.rej" -delete 2>/dev/null || true
          
          # 检查是否有补丁失败
          if [ -s "$PATCH_FAILURES" ]; then
            echo "Summary of skipped/failed patches:"
            cat "$PATCH_FAILURES"
            echo "Build will continue with skipped patches..."
          fi
          
          # 检查关键文件是否包含冲突标记
          echo "Final check for conflict markers..."
          CONFLICT_FILES=$(grep -r "<<<<<<<" . --include="*.h" --include="*.cpp" --include="*.c" --include="*.cc" --include="*.hpp" 2>/dev/null | head -5 || true)
          if [ -n "$CONFLICT_FILES" ]; then
            echo "Found remaining conflict markers, cleaning..."
            find . -type f \( -name "*.h" -o -name "*.cpp" -o -name "*.c" -o -name "*.cc" -o -name "*.hpp" \) \
              -exec sed -i '/^<<<<<<< /d;/^=======$/d;/^>>>>>>> /d' {} \;
          fi
          
          # 验证关键文件
          if [ -f "llvm/include/llvm/ADT/Triple.h" ]; then
            echo "Checking Triple.h for conflicts..."
            if grep -q "<<<<<<<" "llvm/include/llvm/ADT/Triple.h"; then
              echo "Triple.h still has conflict markers, forcing cleanup..."
              sed -i '/^<<<<<<< /d;/^=======$/d;/^>>>>>>> /d' "llvm/include/llvm/ADT/Triple.h"
            fi
          fi
          
          # 清理 llvm_android 目录
          rm -rf "$ROOTDIR/llvm_android"
          
          # 将打好补丁的源码复制到工作目录
          echo "Copying patched source to workspace..."
          rm -rf "$ROOTDIR/llvm"
          cp -r "$ROOTDIR/llvm-project-full"/* "$ROOTDIR/"
          
          echo "Patch application complete."
          echo "Note: Some problematic patches were skipped to ensure build success."

      - name: Setup Zig
        uses: mlugg/setup-zig@v2.0.5
        with:
          version: "0.16.0-dev.577+c50aa2b95"
          use-cache: false

      - name: Setup Zig toolchain
        run: |
          git clone https://github.com/HomuHomu833/zig-as-llvm
          cp -R $ROOTDIR/patches/musl/zig/* $(whereis zig | awk '{print $2}' | xargs dirname)

      - name: Install dependencies
        run: sudo apt install -y ninja-build

      - name: Build dependencies
        run : |
          TOOLCHAIN=${PWD}/zig-as-llvm
          export CC=${TOOLCHAIN}/bin/cc
          export CXX=${TOOLCHAIN}/bin/c++
          export LD=${TOOLCHAIN}/bin/ld
          export OBJCOPY=${TOOLCHAIN}/bin/objcopy
          export AR=${TOOLCHAIN}/bin/ar
          export RANLIB=${TOOLCHAIN}/bin/ranlib
          export STRIP=${TOOLCHAIN}/bin/strip

          rm -rf build output/ zlib/ zstd/

          if ! test -f "${TARGET_INSTALL_DIR}"/lib/libz.a; then
              if ! test -d zlib; then
                  curl -LkSs https://github.com/madler/zlib/releases/download/v1.3.1/zlib-1.3.1.tar.xz | xz -d | tar -x
                  mv zlib-1.3.1 zlib
              fi
              mkdir -p "${TARGET_BUILD_DIR}"/zlib
              (
                  cd ${ROOTDIR}/zlib
                  ./configure --prefix="${TARGET_INSTALL_DIR}" --static
                  make -j"$(nproc --all)" install
              )
          fi

          if ! test -f "${TARGET_INSTALL_DIR}"/lib/libzstd.a; then
              if ! test -d zstd; then
                  curl https://github.com/facebook/zstd/archive/refs/tags/v1.5.6.tar.gz -LkSs | gzip -d | tar -x
                  mv zstd-1.5.6 zstd
              fi

              mkdir -p "${TARGET_INSTALL_DIR}/include"
              mkdir -p "${TARGET_INSTALL_DIR}/lib"
              mkdir -p "${TARGET_BUILD_DIR}/zstd"

              cp "${ROOTDIR}/zstd/lib/zstd.h" "$TARGET_INSTALL_DIR/include/zstd.h"
              (
                  cd "${TARGET_BUILD_DIR}/zstd"

                  $CC -fno-sanitize=undefined $CFLAGS -c \
                      "${ROOTDIR}/zstd/lib/decompress/zstd_ddict.c" \
                      "${ROOTDIR}/zstd/lib/decompress/zstd_decompress.c" \
                      "${ROOTDIR}/zstd/lib/decompress/huf_decompress.c" \
                      "${ROOTDIR}/zstd/lib/decompress/huf_decompress_amd64.S" \
                      "${ROOTDIR}/zstd/lib/decompress/zstd_decompress_block.c" \
                      "${ROOTDIR}/zstd/lib/compress/zstdmt_compress.c" \
                      "${ROOTDIR}/zstd/lib/compress/zstd_opt.c" \
                      "${ROOTDIR}/zstd/lib/compress/hist.c" \
                      "${ROOTDIR}/zstd/lib/compress/zstd_ldm.c" \
                      "${ROOTDIR}/zstd/lib/compress/zstd_fast.c" \
                      "${ROOTDIR}/zstd/lib/compress/zstd_compress_literals.c" \
                      "${ROOTDIR}/zstd/lib/compress/zstd_double_fast.c" \
                      "${ROOTDAR}/zstd/lib/compress/huf_compress.c" \
                      "${ROOTDIR}/zstd/lib/compress/fse_compress.c" \
                      "${ROOTDIR}/zstd/lib/compress/zstd_lazy.c" \
                      "${ROOTDIR}/zstd/lib/compress/zstd_compress.c" \
                      "${ROOTDIR}/zstd/lib/compress/zstd_compress_sequences.c" \
                      "${ROOTDIR}/zstd/lib/compress/zstd_compress_superblock.c" \
                      "${ROOTDIR}/zstd/lib/deprecated/zbuff_compress.c" \
                      "${ROOTDIR}/zstd/lib/deprecated/zbuff_decompress.c" \
                      "${ROOTDIR}/zstd/lib/deprecated/zbuff_common.c" \
                      "${ROOTDIR}/zstd/lib/common/entropy_common.c" \
                      "${ROOTDIR}/zstd/lib/common/pool.c" \
                      "${ROOTDIR}/zstd/lib/common/threading.c" \
                      "${ROOTDIR}/zstd/lib/common/zstd_common.c" \
                      "${ROOTDIR}/zstd/lib/common/xxhash.c" \
                      "${ROOTDIR}/zstd/lib/common/debug.c" \
                      "${ROOTDIR}/zstd/lib/common/fse_decompress.c" \
                      "${ROOTDIR}/zstd/lib/common/error_private.c" \
                      "${ROOTDIR}/zstd/lib/dictBuilder/zdict.c" \
                      "${ROOTDIR}/zstd/lib/dictBuilder/divsufsort.c" \
                      "${ROOTDIR}/zstd/lib/dictBuilder/fastcover.c" \
                      "${ROOTDIR}/zstd/lib/dictBuilder/cover.c"

                  $AR rcs "${TARGET_INSTALL_DIR}/lib/libzstd.a" "${TARGET_BUILD_DIR}"/zstd/*.o
              )
          fi

      - name: Build LLVM
        run: |
          # 在构建前再次检查冲突标记
          echo "Pre-build check for conflict markers..."
          if grep -r "<<<<<<<" "$ROOTDIR/llvm/include/llvm/ADT/Triple.h" 2>/dev/null; then
            echo "Found conflict markers in Triple.h, fixing..."
            sed -i '/^<<<<<<< /d;/^=======$/d;/^>>>>>>> /d' "$ROOTDIR/llvm/include/llvm/ADT/Triple.h"
          fi
          
          TOOLCHAIN=${PWD}/zig-as-llvm
          
          # 确认源代码目录存在
          if [ ! -d "$ROOTDIR/llvm" ]; then
            echo "ERROR: llvm directory not found!"
            ls -la "$ROOTDIR/"
            exit 1
          fi
          
          # 创建构建目录
          mkdir -p "${TARGET_BUILD_DIR}"
          
          echo "Building LLVM for target: ${{matrix.target}}"
          echo "Source directory: $ROOTDIR"
          echo "Build directory: ${TARGET_BUILD_DIR}"

          cmake -S "$ROOTDIR/llvm" -B "${TARGET_BUILD_DIR}" -G Ninja \
            -DCMAKE_INSTALL_PREFIX="${ROOTDIR}/llvm-${{matrix.target}}" \
            -DCMAKE_PREFIX_PATH="${TARGET_INSTALL_DIR}" \
            -DLLVM_TARGETS_TO_BUILD="X86;AArch64;ARM;RISCV" \
            -DCMAKE_BUILD_TYPE=MinSizeRel \
            -DCMAKE_CROSSCOMPILING=True \
            -DCMAKE_SYSTEM_NAME=Linux \
            -DLLVM_DEFAULT_TARGET_TRIPLE=${{matrix.target}} \
            -DCMAKE_C_COMPILER="${TOOLCHAIN}/bin/cc" \
            -DCMAKE_CXX_COMPILER="${TOOLCHAIN}/bin/c++" \
            -DCMAKE_ASM_COMPILER="${TOOLCHAIN}/bin/cc" \
            -DCMAKE_LINKER="${TOOLCHAIN}/bin/ld" \
            -DCMAKE_OBJCOPY="${TOOLCHAIN}/bin/objcopy" \
            -DCMAKE_AR="${TOOLCHAIN}/bin/ar" \
            -DCMAKE_RANLIB="${TOOLCHAIN}/bin/ranlib" \
            -DCMAKE_STRIP="${TOOLCHAIN}/bin/strip" \
            -DCMAKE_C_FLAGS="-static" \
            -DCMAKE_CXX_FLAGS="-static" \
            -DCMAKE_EXE_LINKER_FLAGS="-static" \
            -DLLVM_ENABLE_PROJECTS="${{inputs.projects}}" \
            -DLLVM_ENABLE_ZLIB=FORCE_ON \
            -DLLVM_ENABLE_ZSTD=FORCE_ON \
            -DLLVM_USE_STATIC_ZSTD=ON \
            -DLLVM_BUILD_STATIC=ON \
            -DCLANG_ENABLE_ARCMT=OFF \
            -DLLVM_LINK_LLVM_DYLIB=OFF \
            -DLIBCLANG_BUILD_STATIC=ON \
            -DCMAKE_SKIP_INSTALL_RPATH=TRUE \
            -DBUILD_SHARED_LIBS=OFF \
            -DLLVM_INCLUDE_BENCHMARKS=OFF \
            -DLLVM_BUILD_BENCHMARKS=OFF \
            -DLLVM_INCLUDE_EXAMPLES=OFF \
            -DLLVM_BUILD_EXAMPLES=OFF \
            -DLLVM_BUILD_TESTS=OFF \
            -DLLVM_BUILD_TOOLS=ON \
            -DLLVM_INCLUDE_TESTS=OFF \
            -DCLANG_INCLUDE_TESTS=OFF \
            -DCLANG_BUILD_TESTS=OFF \
            -DLLVM_TOOL_C_TEST_BUILD=OFF \
            -DCLANG_TOOL_CLANG_IMPORT_TEST_BUILD=OFF \
            -DCLANG_TOOL_APINOTES_TEST_BUILD=OFF \
            -DCLANG_TOOL_ARCMT_TEST_BUILD=OFF \
            -DCLANG_TOOL_C_ARCMT_TEST_BUILD=OFF \
            -DCLANG_TOOL_C_INDEX_TEST_BUILD=OFF \
            -DLLVM_PARALLEL_LINK_JOBS=1 \
            -DLLVM_ENABLE_PIC=OFF \
            -DLLVM_ENABLE_LIBCXX=OFF \
            -DLLVM_ENABLE_LLVM_LIBC=OFF \
            -DLLVM_ENABLE_UNWIND_TABLES=OFF \
            -DLLVM_ENABLE_EH=OFF \
            -DLLVM_ENABLE_RTTI=OFF \
            -DLLVM_ENABLE_LTO=OFF \
            -DLLVM_ENABLE_TERMINFO=OFF \
            -DLLVM_ENABLE_MODULES=OFF \
            -DLLVM_ENABLE_PEDANTIC=OFF \
            -DLLVM_ENABLE_FFI=OFF \
            -DLLVM_ENABLE_LIBPFM=OFF \
            -DLLVM_ENABLE_LIBEDIT=OFF \
            -DLLVM_ENABLE_LIBXML2=OFF \
            -DLLVM_ENABLE_CURL=OFF \
            -DLLVM_ENABLE_THREADS=ON \
            -DLLVM_VERSION_SUFFIX="" \
            -DCLANG_VENDOR="Android" \
            -DCLANG_REPOSITORY_STRING="https://github.com/${{ github.repository_owner }}/llvm-custom" \
            -DPACKAGE_BUGREPORT="https://github.com/${{ github.repository_owner }}/android-ndk-custom/issues/"

          cmake --build "${TARGET_BUILD_DIR}" --target install -j$(nproc)

      - name: Check
        run: |
          file llvm-${{matrix.target}}/bin/* || true
          tree llvm-${{matrix.target}} || true

      - name: Compress
        run: |
          projects=$(echo "${{inputs.projects}}" | tr ";" "+")
          tarball_name=${projects}-r${{inputs.version}}${{inputs.revision}}-${{matrix.target}}
          echo tarball_name=${tarball_name} >> ${GITHUB_ENV}
          mv llvm-${{matrix.target}} ${tarball_name}
          tar -c ${tarball_name} | xz -T0 -v >${tarball_name}.tar.xz

      - name: Upload release
        uses: ncipollo/release-action@v1.20.0
        with:
          tag: "llvm-r${{inputs.version}}"
          artifacts: ${{env.tarball_name}}.tar.xz
          allowUpdates: true
          replacesArtifacts: true
          body: ''
